---

- name: install python3 and pip3
  package:
    name: "{{ item }}"
    state: present
  loop:
  - "{{ python_requirements }}"

- name: "python3: get python executable"
  shell: |
    set -o pipefail
    which {{ python3_command }}
  args:
    executable: /bin/bash
  register: python3_which
  changed_when: false
  failed_when: python3_which.rc >= 2

- name: "python3: install pip"
  become: true
  command: "{{ python3_command }} -m ensurepip"
  changed_when: false
  when: ansible_os_family == 'RedHat'

- name: "python3: get pip executable"
  shell: |
    set -o pipefail
    which {{ pip3_command }}
  args:
    executable: /bin/bash
  register: pip3_which
  changed_when: false
  failed_when: pip3_which.rc >= 2

# https://github.com/pypa/pip/issues/5599
- name: "python3: upgrade pip"
  shell: |
    set -o pipefail
    {{ python3_which.stdout }} -m pip install --upgrade pip
  args:
    executable: /bin/bash
  changed_when: false
