---

- name: "Latest python3 all other distros"
  when:
    - not (ansible_distribution == 'Ubuntu' and ansible_distribution_release == 'xenial')
    - ansible_os_family != 'Darwin'
  block:
    - name: Install python3 and pip3
      package:
        name: "{{ item }}"
        state: present
      become: true
      become_user: "root"
      loop:
        - "{{ python_requirements }}"

- name: "Latest python3 xenial"
  when: ansible_distribution == 'Ubuntu' and ansible_distribution_release == 'xenial'
  block:
    - name: Ubuntu xenial python install fix
      shell: |
        set -o pipefail
        sudo add-apt-repository ppa:fkrull/deadsnakes
        sudo apt-get update -qqy
        {{ ansible_pkg_mgr }} install -qqy python3.7 python3-pip
      args:
        executable: /bin/bash
      become: true
      become_user: "root"
      changed_when: false

- name: Get python executable
  shell: |
    set -o pipefail
    ls /usr/bin/python3* | grep -E "python[0-9]{1,2}$" | awk '{print $1}' | xargs
  args:
    executable: /bin/bash
  register: python3_which
  changed_when: false

#- name: "Python3: install pip"
#  become: true
#  command: "{{ python3_command }} -m ensurepip"
#  changed_when: false
#  when: ansible_os_family == 'RedHat'

#- name: "Python3: get pip executable"
#  shell: |
#    set -o pipefail
#    which {{ pip3_command }}
#  args:
#    executable: /bin/bash
#  register: pip3_which
#  changed_when: false
#  failed_when: pip3_which.rc >= 2

# https://github.com/pypa/pip/issues/5599
- name: "Python3: upgrade pip"
  shell: |
    set -o pipefail
    {{ python3_which.stdout }} -m pip install --upgrade --force-reinstall pip
  args:
    executable: /bin/bash
  changed_when: false
#  become: true
#  become_user: "root"
  when: ansible_distribution_release != "noble"
